# AI 原生开发工作流指南

本文档记录了 `learn-claude-code` 项目中用于优化 AI 辅助开发的核心理念和机制。它融合了 **分级懒加载 (Fractional Lazy Loading)** 和 **自动文档 (Auto-Doc)** 两个关键模式。

## 1. 核心问题

在大型 AI 辅助项目中，我们面临两个相互冲突的挑战：

1.  **上下文膨胀 (Context Bloat)**：向 AI 灌输过多信息（全局规则、无关代码）会浪费 Token 并使模型感到困惑。
2.  **文档腐烂 (Documentation Decay)**：随着代码的快速迭代，文档往往滞后，导致 AI 后续在尝试理解系统时产生幻觉。

## 2. 解决方案："上下文优先"架构

我们通过让文件系统本身成为 AI 的"长期记忆"来解决这个问题，并以一种可自动检索的方式进行组织。

### 2.1 分级懒加载 (输入端优化)

**概念**：我们不再在根目录下使用单一巨大的 `CLAUDE.md`，而是将上下文拆分为分层的配置文件。

-   **祖先级 (`/CLAUDE.md`)**：仅包含全局指针（重定向到 `.claude/AGENTS.md`）。
-   **后代级 (`/subdir/CLAUDE.md`)**：包含*特定于*该目录的规则。
    -   *示例*：`docs/CLAUDE.md` 强制执行 Markdown 规则；`scripts/CLAUDE.md` 强制执行 PEP 8。

**机制**：当你编辑 `scripts/` 中的文件时，Claude Code 会自动加载 `scripts/CLAUDE.md`。它*不会*加载 `frontend/` 或 `backend/` 中无关的规则。

### 2.2 具有"单一信源"的 Auto-Doc (输出端维护)

**概念**：我们强制执行三层文档结构，该结构与代码更改*同步*更新。为了减少文件混乱，我们将"目录索引"合并到本地 `CLAUDE.md` 中。

#### 三层结构：

**第 1 层：`ARCHITECTURE.md` (根目录)**
-   **内容**：高层设计图。
-   **更新时机**：仅在重大架构变动时更新。

**第 2 层：`CLAUDE.md` (每个目录)**
-   **内容**：兼作 **规则书 (Rulebook)** 和 **清单 (Manifest)**。
-   **结构**：
    ```markdown
    # 目录上下文
    ## 职责
    (该文件夹的作用)
    ## 文件清单
    | 文件 | 角色 | 依赖 |
    |------|------|------|
    ## 编码标准
    (特定于该文件夹的规则)
    ```
-   **更新时机**：每当添加、删除文件或文件用途改变时。

**第 3 层：头部注释 (每个文件)**
-   **内容**：原子级元数据。
-   **格式**：
    ```python
    """
    @module: scripts.tui_menu
    @desc: 交互式菜单控制器
    @input: 用户按键输入
    @output: Shell 命令
    """
    ```
-   **更新时机**：每当逻辑改变时。

## 3. "编辑循环"工作流

在开发功能时，AI（或你）遵循此循环：

1.  **读取上下文**：AI 进入目录 -> 自动加载 `CLAUDE.md` -> 理解 *规则* 和 *文件清单*。
2.  **编辑代码**：AI 修改 `script.py`。
3.  **更新第 3 层**：AI 更新 `script.py` 中的 `@desc`。
4.  **更新第 2 层**：AI 检查 `CLAUDE.md` -> 如有需要，更新"文件清单"表。
5.  **提交**：代码库保持自文档化状态。

## 4. 收益

-   **零幻觉**：AI 始终能看到当前目录的最新清单。
-   **Token 高效**：仅加载相关上下文。
-   **易维护**：文档是分布式的且易于管理的，而不是一个庞然大物。
